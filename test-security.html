<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë³´ì•ˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      button {
        margin: 5px;
        padding: 10px;
      }
      input,
      textarea {
        margin: 5px;
        padding: 5px;
        width: 300px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ë³´ì•ˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>

    <!-- 1. JWT í† í° í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
      <h2>1. JWT í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸</h2>
      <button onclick="testRegister()">ì‚¬ìš©ì ë“±ë¡</button>
      <button onclick="testLogin()">ë¡œê·¸ì¸</button>
      <button onclick="testRefreshToken()">í† í° ê°±ì‹ </button>
      <div id="token-result" class="result"></div>
    </div>

    <!-- 2. Rate Limiting í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
      <h2>2. Rate Limiting í…ŒìŠ¤íŠ¸</h2>
      <button onclick="testRateLimit()">ë¹ ë¥¸ ìš”ì²­ í…ŒìŠ¤íŠ¸ (100íšŒ)</button>
      <div id="rate-limit-result" class="result"></div>
    </div>

    <!-- 3. ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
      <h2>3. ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸</h2>
      <input
        type="text"
        id="test-message"
        placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ (HTML íƒœê·¸ í¬í•¨ ê°€ëŠ¥)"
        value="<script>alert('xss')</script>ì•ˆë…•í•˜ì„¸ìš”!"
      />
      <button onclick="testInputValidation()">ë©”ì‹œì§€ ê²€ì¦ í…ŒìŠ¤íŠ¸</button>
      <div id="input-result" class="result"></div>
    </div>

    <!-- 4. ë³´ì•ˆ í—¤ë” í™•ì¸ -->
    <div class="test-section">
      <h2>4. ë³´ì•ˆ í—¤ë” í™•ì¸</h2>
      <button onclick="checkSecurityHeaders()">ë³´ì•ˆ í—¤ë” í™•ì¸</button>
      <div id="headers-result" class="result"></div>
    </div>

    <script>
      let accessToken = '';
      let refreshToken = '';

      // 1. ì‚¬ìš©ì ë“±ë¡
      async function testRegister() {
        const result = document.getElementById('token-result');
        result.innerHTML = '<div class="info">ë“±ë¡ ì¤‘...</div>';

        try {
          const response = await fetch('http://localhost:3001/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'test@example.com',
              password: 'testpassword123',
              name: 'Test User',
            }),
          });

          const data = await response.json();
          if (response.ok) {
            accessToken = data.accessToken;
            refreshToken = data.refreshToken;
            result.innerHTML = `
                        <div class="success">âœ… ë“±ë¡ ì„±ê³µ!</div>
                        <div>Access Token: ${accessToken.substring(0, 30)}...</div>
                        <div>Refresh Token: ${refreshToken.substring(0, 30)}...</div>
                    `;
          } else {
            result.innerHTML = `<div class="error">âŒ ë“±ë¡ ì‹¤íŒ¨: ${data.message || 'Unknown error'}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</div>`;
        }
      }

      // 2. ë¡œê·¸ì¸
      async function testLogin() {
        const result = document.getElementById('token-result');
        result.innerHTML = '<div class="info">ë¡œê·¸ì¸ ì¤‘...</div>';

        try {
          const response = await fetch('http://localhost:3001/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'test@example.com',
              password: 'testpassword123',
            }),
          });

          const data = await response.json();
          if (response.ok) {
            accessToken = data.accessToken;
            refreshToken = data.refreshToken;
            result.innerHTML = `
                        <div class="success">âœ… ë¡œê·¸ì¸ ì„±ê³µ!</div>
                        <div>Access Token: ${accessToken.substring(0, 30)}...</div>
                        <div>Refresh Token: ${refreshToken.substring(0, 30)}...</div>
                    `;
          } else {
            result.innerHTML = `<div class="error">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message || 'Unknown error'}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</div>`;
        }
      }

      // 3. í† í° ê°±ì‹ 
      async function testRefreshToken() {
        const result = document.getElementById('token-result');
        if (!refreshToken) {
          result.innerHTML = '<div class="error">âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”</div>';
          return;
        }

        result.innerHTML = '<div class="info">í† í° ê°±ì‹  ì¤‘...</div>';

        try {
          const response = await fetch('http://localhost:3001/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken }),
          });

          const data = await response.json();
          if (response.ok) {
            accessToken = data.accessToken;
            result.innerHTML = `
                        <div class="success">âœ… í† í° ê°±ì‹  ì„±ê³µ!</div>
                        <div>New Access Token: ${accessToken.substring(0, 30)}...</div>
                    `;
          } else {
            result.innerHTML = `<div class="error">âŒ í† í° ê°±ì‹  ì‹¤íŒ¨: ${data.message || 'Unknown error'}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</div>`;
        }
      }

      // 4. Rate Limiting í…ŒìŠ¤íŠ¸
      async function testRateLimit() {
        const result = document.getElementById('rate-limit-result');
        result.innerHTML = '<div class="info">Rate Limiting í…ŒìŠ¤íŠ¸ ì¤‘... (100íšŒ ìš”ì²­)</div>';

        let successCount = 0;
        let errorCount = 0;
        const startTime = Date.now();

        for (let i = 0; i < 100; i++) {
          try {
            const response = await fetch('http://localhost:3001/auth/profile', {
              headers: { Authorization: `Bearer ${accessToken}` },
            });

            if (response.ok) {
              successCount++;
            } else if (response.status === 429) {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
          }

          // ì§„í–‰ ìƒí™© í‘œì‹œ
          if (i % 10 === 0) {
            result.innerHTML = `<div class="info">ì§„í–‰ ì¤‘... ${i}/100 (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${errorCount})</div>`;
          }
        }

        const endTime = Date.now();
        const duration = endTime - startTime;

        result.innerHTML = `
                <div class="success">âœ… Rate Limiting í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</div>
                <div>ì´ ìš”ì²­: 100íšŒ</div>
                <div>ì„±ê³µ: ${successCount}íšŒ</div>
                <div>ì‹¤íŒ¨: ${errorCount}íšŒ</div>
                <div>ì†Œìš” ì‹œê°„: ${duration}ms</div>
                <div>í‰ê·  ì‘ë‹µ ì‹œê°„: ${(duration / 100).toFixed(2)}ms</div>
            `;
      }

      // 5. ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸
      async function testInputValidation() {
        const result = document.getElementById('input-result');
        const testMessage = document.getElementById('test-message').value;

        result.innerHTML = '<div class="info">ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸ ì¤‘...</div>';

        try {
          const response = await fetch('http://localhost:3001/rooms', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              name: testMessage,
              description: 'í…ŒìŠ¤íŠ¸ìš© ë£¸ì…ë‹ˆë‹¤.',
            }),
          });

          const data = await response.json();
          if (response.ok) {
            result.innerHTML = `
                        <div class="success">âœ… ì…ë ¥ ê²€ì¦ í†µê³¼!</div>
                        <div>ì›ë³¸ ë©”ì‹œì§€: ${testMessage}</div>
                        <div>ì²˜ë¦¬ëœ ë©”ì‹œì§€: ${data.name || 'N/A'}</div>
                    `;
          } else {
            result.innerHTML = `
                        <div class="error">âŒ ì…ë ¥ ê²€ì¦ ì‹¤íŒ¨: ${data.message || 'Unknown error'}</div>
                        <div>ì›ë³¸ ë©”ì‹œì§€: ${testMessage}</div>
                    `;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</div>`;
        }
      }

      // 6. ë³´ì•ˆ í—¤ë” í™•ì¸
      async function checkSecurityHeaders() {
        const result = document.getElementById('headers-result');
        result.innerHTML = '<div class="info">ë³´ì•ˆ í—¤ë” í™•ì¸ ì¤‘...</div>';

        try {
          const response = await fetch('http://localhost:3001');
          const headers = response.headers;

          const securityHeaders = [
            'x-content-type-options',
            'x-frame-options',
            'x-xss-protection',
            'content-security-policy',
            'strict-transport-security',
          ];

          let headerInfo = '<div class="success">âœ… ë³´ì•ˆ í—¤ë” í™•ì¸ ì™„ë£Œ!</div>';

          securityHeaders.forEach((header) => {
            const value = headers.get(header);
            if (value) {
              headerInfo += `<div class="success">${header}: ${value}</div>`;
            } else {
              headerInfo += `<div class="error">${header}: ì—†ìŒ</div>`;
            }
          });

          result.innerHTML = headerInfo;
        } catch (error) {
          result.innerHTML = `<div class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</div>`;
        }
      }
    </script>
  </body>
</html>
